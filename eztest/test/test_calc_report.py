import os
import unittest

from eztest import calc_report, utility


class TestCalcReport(unittest.TestCase):
    def test_file_path_is_dir(self):
        with utility.SysStandardOutput() as output:
            calc_report.calc('reports')

        self.assertIn('Case1,135,7539,1.7907%,3.69,26.583,17.76997945964989', output)
        self.assertIn('Case2,1,2,50.0000%,16.461,26.072,21.2665', output)
        self.assertIn('Case3,1,2,50.0000%,16.461,26.072,21.2665', output)

        self.assertIn('Case1,1,2018-06-18 10:32:00,2018-06-18 11:32:00,72,3938,1.8283%,3.72,26.583,16.959928979894286\n'
                      'Case1,2,2018-06-18 11:32:00,2018-06-18 12:32:00,63,3600,1.7500%,3.69,25.363,17.76997945964989\n'
                      'Case1,3,2018-06-18 12:32:00,2018-06-18 13:32:00,0,1,0.0000%,16.491,16.491,16.491', output)
        self.assertIn('Case2,1,2018-06-18 10:32:00,2018-06-18 11:32:00,0,1,0.0000%,26.072,26.072,26.072\n'
                      'Case2,2,2018-06-18 11:32:00,2018-06-18 12:32:00,1,1,100.0000%,16.461,16.461,16.461', output)
        self.assertIn('Case3,1,2018-06-18 10:32:00,2018-06-18 11:32:00,0,1,0.0000%,26.072,26.072,26.072\n'
                      'Case3,2,2018-06-18 11:32:00,2018-06-18 12:32:00,1,1,100.0000%,16.461,16.461,16.461', output)

        del output

        with utility.SysStandardOutput() as output:
            calc_report.calc('reports', group_minutes=30)

        self.assertIn('Case1,135,7539,1.7907%,3.69,26.583,17.76997945964989', output)
        self.assertIn('Case2,1,2,50.0000%,16.461,26.072,21.2665', output)
        self.assertIn('Case3,1,2,50.0000%,16.461,26.072,21.2665', output)

        self.assertIn('Case1,1,2018-06-18 10:32:00,2018-06-18 11:02:00,30,1938,1.5480%,3.83,26.583,16.469082024050984\n'
                      'Case1,2,2018-06-18 11:02:00,2018-06-18 11:32:00,42,2000,2.1000%,3.72,18.932,16.959928979894286\n'
                      'Case1,3,2018-06-18 11:32:00,2018-06-18 12:02:00,38,1932,1.9669%,3.69,25.363,16.23456723705196\n'
                      'Case1,4,2018-06-18 12:02:00,2018-06-18 12:32:00,25,1668,1.4988%,3.72,20.412,17.76997945964989\n'
                      'Case1,5,2018-06-18 12:32:00,2018-06-18 13:02:00,0,1,0.0000%,16.491,16.491,16.491', output)
        self.assertIn('Case2,1,2018-06-18 10:32:00,2018-06-18 11:02:00,0,1,0.0000%,26.072,26.072,26.072\n'
                      'Case2,2,2018-06-18 11:02:00,2018-06-18 11:32:00,0,0,0.0000%,,,\n'
                      'Case2,3,2018-06-18 11:32:00,2018-06-18 12:02:00,1,1,100.0000%,16.461,16.461,16.461', output)
        self.assertIn('Case3,1,2018-06-18 10:32:00,2018-06-18 11:02:00,0,1,0.0000%,26.072,26.072,26.072\n'
                      'Case3,2,2018-06-18 11:02:00,2018-06-18 11:32:00,0,0,0.0000%,,,\n'
                      'Case3,3,2018-06-18 11:32:00,2018-06-18 12:02:00,1,1,100.0000%,16.461,16.461,16.461', output)

        del output

    def test_file_path_is_file(self):
        with utility.SysStandardOutput() as output:
            calc_report.calc(os.path.join('reports', 'report1.csv'))

        self.assertIn('Case1,68,3835,1.7731%,3.69,26.583,16.610214623718797', output)
        self.assertIn('Case2,1,2,50.0000%,16.461,26.072,21.2665', output)

        self.assertIn('Case1,1,2018-06-18 10:32:00,2018-06-18 11:32:00,36,1969,1.8283%,3.72,26.583,16.959928979894286\n'
                      'Case1,2,2018-06-18 11:32:00,2018-06-18 12:32:00,32,1865,1.7158%,3.69,25.363,16.72942924743759\n'
                      'Case1,3,2018-06-18 12:32:00,2018-06-18 13:32:00,0,1,0.0000%,16.491,16.491,16.491', output)
        self.assertIn('Case2,1,2018-06-18 10:32:00,2018-06-18 11:32:00,0,1,0.0000%,26.072,26.072,26.072\n'
                      'Case2,2,2018-06-18 11:32:00,2018-06-18 12:32:00,1,1,100.0000%,16.461,16.461,16.461', output)

        del output

        with utility.SysStandardOutput() as output:
            calc_report.calc(os.path.join('reports', 'report2.csv'), group_minutes=30)

        self.assertIn('Case1,67,3704,1.8089%,3.69,26.583,17.76997945964989', output)
        self.assertIn('Case3,1,2,50.0000%,16.461,26.072,21.2665', output)

        self.assertIn('Case1,1,2018-06-18 10:32:00,2018-06-18 11:02:00,15,969,1.5480%,3.83,26.583,16.469082024050984\n'
                      'Case1,2,2018-06-18 11:02:00,2018-06-18 11:32:00,21,1000,2.1000%,3.72,18.932,16.959928979894286\n'
                      'Case1,3,2018-06-18 11:32:00,2018-06-18 12:02:00,19,966,1.9669%,3.69,25.363,16.23456723705196\n'
                      'Case1,4,2018-06-18 12:02:00,2018-06-18 12:32:00,12,769,1.5605%,3.72,20.412,17.76997945964989', output)
        self.assertIn('Case3,1,2018-06-18 10:32:00,2018-06-18 11:02:00,0,1,0.0000%,26.072,26.072,26.072\n'
                      'Case3,2,2018-06-18 11:02:00,2018-06-18 11:32:00,0,0,0.0000%,,,\n'
                      'Case3,3,2018-06-18 11:32:00,2018-06-18 12:02:00,1,1,100.0000%,16.461,16.461,16.461', output)

        del output


if __name__ == '__main__':
    unittest.main()